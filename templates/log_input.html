{% extends "base.html" %}
{% block title %}ë¡œê·¸ ë¶„ì„ ìš”ì²­{% endblock %}
{% block header %}<div class="top-header">Log</div>{% endblock %}

{% block content %}
<style>
  html, body {
    height: 100%;
  }

  .page-body {
    display: flex;
    gap: 24px;
    padding: 24px;
    height: auto;
    overflow: hidden;
  }

  .form-container {
    flex: 1.5;
    background: white;
    border-radius: 2px;
    padding: 10px 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    min-height: 680px; /* ğŸ‘ˆ ì´ ì¤„ì„ ì¶”ê°€í•˜ë©´ ì•„ë˜ë¡œ ì—¬ìœ  ìƒê¹€ */
  }

  .calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0.5rem 0;
  }

  .calendar-nav button {
    padding: 0.3rem 0.8rem;
    font-size: 0.7rem;
    background-color: #e5e7eb;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  table.calendar {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 0.2rem;
    font-size: 12px;
  }

  .calendar th, .calendar td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: center;
    cursor: pointer;
  }

  .calendar td.highlight {
    background-color: #10b981;
    color: white;
    font-weight: bold;
  }

  .calendar td.disabled {
    background-color: #f9fafb;
    color: #cbd5e1;
    pointer-events: none;
  }

  .date-range {
    display: flex;
    gap: 8px;
    align-items: center;
    margin: 1px 0 30px;
  }

  .date-range input {
  background-color: #f9fafb;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 12px;
  font-family: 'Segoe UI', sans-serif;
  width: 130px;
  pointer-events: none; /* í´ë¦­ ë°©ì§€ */
}


  .output-container {
    flex: 2.2;
    background: #1e1e1e;
    color: #c9d1d9;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    border-radius: 2px;
    padding: 24px;
    max-height: 100%;
    overflow-y: auto;
    white-space: pre-wrap;
    box-sizing: border-box;
    min-height: 680px; /* ğŸ‘ˆ ì´ ì¤„ì„ ì¶”ê°€í•˜ë©´ ì•„ë˜ë¡œ ì—¬ìœ  ìƒê¹€ */
  }

  label {
    font-weight: 600;
    margin-top: 6px;
    margin-bottom: 6px;
    display: block;
  }

  input[type="date"],
  textarea {
    width: 100%;
    padding: 10px;
    border-radius: 2px;
    border: 1px solid #d1d5db;
    font-size: 12px;
    font-family: 'Segoe UI', sans-serif;
    margin-top: 6px;
    box-sizing: border-box;
  }

  textarea {
    height: 140px;
    resize: vertical;
    margin-bottom: 12px;
  }

  #sendBtn {
    background-color: #10b981;
    color: white;
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
    width: 100%;
  }

  #sendBtn:hover {
    background-color: #059669;
  }
</style>

<div class="page-body">
  <!-- ì™¼ìª½ ì…ë ¥ ì˜ì—­ -->
  <div class="form-container">
    <h4>ê¸°ê°„ ì„ íƒ</h4>

    <div class="calendar-nav">
      <button onclick="prevMonth()">ì´ì „</button>
      <strong id="monthYear"></strong>
      <button onclick="nextMonth()">ë‹¤ìŒ</button>
    </div>
    <table class="calendar" id="calendar"></table>

    <div class="date-range">
      <input type="date" id="start" name="start" readonly />
      <span>~</span>
      <input type="date" id="end" name="end" readonly />
    </div>

    <label for="prompt">í”„ë¡¬í”„íŠ¸ ì…ë ¥</label>
    <textarea id="prompt" name="prompt" placeholder="ì˜ˆ: IP ê¶Œí•œ ìƒìŠ¹ ê²½ë¡œì— ëŒ€í•´ì„œ ìì„¸íˆ ë¶„ì„í•´ì¤˜(ì˜ì–´/í•œêµ­ì–´)"></textarea>
    <button id="sendBtn">ë³´ë‚´ê¸°</button>
  </div>

  <!-- ì˜¤ë¥¸ìª½ ë¡œê·¸ ì¶œë ¥ -->
  <div class="output-container">
    <div id="logOutput">
      ë¡œê·¸ ìˆ˜ì§‘í•˜ëŠ” ê³¼ì •ì„ ì—¬ê¸°ì—ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    </div>
  </div>
</div>

<script>
  const sendBtn = document.getElementById('sendBtn');
  const logOutput = document.getElementById('logOutput');
  const startInput = document.getElementById("start");
  const endInput = document.getElementById("end");
  const calendar = document.getElementById("calendar");
  const monthYear = document.getElementById("monthYear");
  let viewDate = new Date();
  let clickState = { clickCount: 0, firstDate: "" };


sendBtn.addEventListener('click', async () => {
  const start = startInput.value;
  const end = endInput.value;
  const rawPrompt = document.getElementById('prompt').value.trim();

  if (!start || !end || !rawPrompt) {
    alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  const prompt = rawPrompt;  // chat.htmlì—ì„œ í¬ë§· ì²˜ë¦¬í•¨
  const reportId = `report_${start.replace(/-/g, '')}_${end.replace(/-/g, '')}`;

  logOutput.innerText = `ğŸŸ¢ ${start} ~ ${end} ë¡œê·¸ ìˆ˜ì§‘ ìš”ì²­ ì¤‘...\nğŸ“¡ ì „ì†¡ ì¤‘...\n`;
  sendBtn.disabled = true;

  try {
    const response = await fetch("/collect", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ start, end, prompt }),
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let resultText = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      logOutput.innerText += chunk;
      resultText += chunk;
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    // âœ… ë¦¬í¬íŠ¸ ìƒì„± ë° ì €ì¥
    const reports = JSON.parse(localStorage.getItem('reports') || '[]');
    if (!reports.includes(reportId)) {
      reports.push(reportId);
      localStorage.setItem('reports', JSON.stringify(reports));
    }

    // âœ… ë¡œê·¸, ë‚ ì§œ ì €ì¥ (chatì€ ë¹„ì›Œë‘ê¸°)
    localStorage.setItem(`chat_${reportId}`, JSON.stringify([]));
    localStorage.setItem(`log_${reportId}`, resultText);
    localStorage.setItem(`range_${reportId}`, JSON.stringify({ start, end }));

    // âœ… chat.htmlë¡œ ì´ë™ (ìë™ ë¶„ì„)
    const query = new URLSearchParams({
      selected_report: reportId,
      prompt,
      start,
      end
    }).toString();
    window.location.href = `/chat?${query}`;

  } catch (error) {
    logOutput.innerText += `\nâŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
  } finally {
    sendBtn.disabled = false;
  }
});



  function renderCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    monthYear.textContent = `${year}ë…„ ${month + 1}ì›”`;
    let html = `<tr><th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th></tr><tr>`;

    let day = 1;
    for (let i = 0; i < 42; i++) {
      if (i % 7 === 0 && i !== 0) html += "</tr><tr>";
      if (i < firstDay || day > lastDate) {
        html += "<td class='disabled'></td>";
      } else {
        const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        html += `<td data-date="${fullDate}">${day}</td>`;
        day++;
      }
    }
    html += "</tr>";
    calendar.innerHTML = html;

    calendar.querySelectorAll("td[data-date]").forEach(td => {
      td.addEventListener("click", () => handleDateClick(td.dataset.date));
    });

    highlightDateRange(startInput.value, endInput.value);
  }

  function handleDateClick(date) {
    if (clickState.clickCount === 0) {
      startInput.value = date;
      endInput.value = "";
      clickState.firstDate = date;
      clickState.clickCount = 1;
      highlightDateRange(date, date);
    } else {
      const [start, end] = [clickState.firstDate, date].sort();
      startInput.value = start;
      endInput.value = end;
      clickState.clickCount = 0;
      clickState.firstDate = "";
      highlightDateRange(start, end);
    }
  }

  function highlightDateRange(start, end) {
    calendar.querySelectorAll("td[data-date]").forEach(td => {
      const date = td.getAttribute("data-date");
      if (start && end && date >= start && date <= end) {
        td.classList.add("highlight");
      } else {
        td.classList.remove("highlight");
      }
    });
  }

  function prevMonth() {
    viewDate.setMonth(viewDate.getMonth() - 1);
    renderCalendar(viewDate);
  }

  function nextMonth() {
    viewDate.setMonth(viewDate.getMonth() + 1);
    renderCalendar(viewDate);
  }

  renderCalendar(viewDate);
</script>
{% endblock %}
