{% extends "base.html" %}
{% block title %}LLM{% endblock %}
{% block header %}<div class="top-header">LLM</div>{% endblock %}

{% block content %}
<style>
  body, html {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #f9fafb;
  }

  .chat-layout {
    display: flex;
    height: calc(100vh - 15vh);
    width: 100%;      /* ì „ì²´ ë„ˆë¹„ ë³´ì¥ */
    min-width: 0; 
    overflow: hidden;
  }

  .chat-sidebar {
    width: 260px;
    background-color: #ffffff;
    border-right: 1px solid #e5e7eb;
    padding: 16px;
    display: flex;
    flex-direction: column;
    flex-shrink: 0; /* âœ… ì‚¬ì´ë“œë°” ë„ˆë¹„ ê³ ì • */
  }

  .chat-sidebar h4 {
    margin: 10px 0 12px;
  }

  .chat-sidebar input {
    padding: 8px;
    font-size: 14px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    margin-bottom: 16px;
  }

  .chat-sidebar ul {
    list-style: none;
    padding: 0;
    margin: 0;
    flex: 1;
    overflow-y: auto;
  }

  .chat-sidebar ul li {
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    margin-bottom: 5px;
  }

  .chat-sidebar ul li a {
  text-decoration: none;
  color: inherit;
  display: block;
  width: 100%;
  height: 100%;
}


  .chat-sidebar ul li:hover,
  .chat-sidebar ul li.active {
    background-color: #e0e7ff;
    font-weight: 500;
  }

  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: #ffffff;
    padding: 16px;
    overflow: hidden;
    min-width: 0;     /* âœ… í•µì‹¬ ì¶”ê°€ */
  }

  .chat-toolbar {
    display: flex;
    justify-content: flex-end;
    gap: 20px;
    margin-bottom: 14px;
  }

  .chat-toolbar select,
  .chat-toolbar button {
    padding: 8px 14px;
    font-size: 10px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background-color: #f9fafb;
    cursor: pointer;
  }

  .chat-toolbar button {
    background-color: black;
    font-size: 12px;
    color: white;
    border: none;
  }

  .chat-body {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow-x: hidden;  /* ğŸ’¡ ìˆ˜í‰ ìŠ¤í¬ë¡¤ ë°©ì§€ */
  }

  .message-bubble {
  max-width: 700px;
  width: fit-content;
  padding: 10px 14px;
  border-radius: 20px;
  display: inline-block;
  font-size: 12px;
  word-break: break-word;       /* âœ… ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆ */
  white-space: pre-wrap;        /* âœ… ì¤„ë°”ê¿ˆ ìœ ì§€ + ì¤„ë°”ê¿ˆ ê°€ëŠ¥ */
  overflow-wrap: break-word;    /* âœ… ê¸¸ì´ ì´ˆê³¼ ë‹¨ì–´ ì˜ë¼ë‚´ê¸° */    /* âœ… ìˆ˜í‰ ìŠ¤í¬ë¡¤ ë°©ì§€ */
}

.message-bubble pre,
.message-bubble code {
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: break-word;
  max-width: 100%;
}

  .from-user {
    align-self: flex-end;
    background-color: #6366f1;
    color: white;
  }

  .from-assistant {
    align-self: flex-start;
    background-color: #fef3c7;
    color: #111827;
  }

  .chat-footer {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid #e5e7eb;
  }

  .chat-footer textarea {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    resize: none;
    font-size: 12px;
    line-height: 1.4;
    min-height: 20px;
    max-height: 140px;
    overflow-y: auto;
  }

  .chat-footer button {
    padding: 10px 20px;
    background-color: #6366f1;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 11px;
  }

    .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    padding: 80px 0;
    text-align: center;
    flex: 1;
  }

  .empty-state img {
    width: 60px;
    margin-bottom: 20px;
    opacity: 0.3;
  }

  .empty-state h3 {
    font-size: 18px;
    margin-bottom: 6px;
    color: #111827;
  }

  .empty-state p {
    font-size: 13px;
    margin-bottom: 12px;
  }

  .start-button {
    background-color: black;
    color: white;
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 12px;
    border: none;
    cursor: pointer;
  }


 .report-item-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 2px 10px;
}

.report-menu-container {
  position: relative;
}

.report-menu-btn {
  background: none;
  border: none;
  font-size: 16px;
  color: #6b7280;
  cursor: pointer;
  padding: 4px 6px;
}

.report-dropdown {
  position: absolute;
  top: 24px;
  right: 0;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  z-index: 100;
  min-width: 100px;
  display: none;
}

.report-dropdown button {
  width: 100%;
  padding: 8px 12px;
  background: none;
  border: none;
  text-align: left;
  font-size: 10px;
  cursor: pointer;
  color: #ef4444;
}

.report-dropdown button:hover {
  background-color: #fef2f2;
}

.dropdown-container {
  position: relative;
}

.plus-button {
  min-width: 100%;
  padding: 0 16px;
  font-size: 18px;
  background-color: #6366f1;
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;

  align-self: stretch;
  height: 100%;        /* âœ… ê°€ì¥ ê°•ë ¥í•œ stretch */
  min-height: inherit; /* âœ… ë¶€ëª¨ì˜ ëŠ˜ì–´ë‚œ ë†’ì´ë¥¼ ìƒì† */
}

.plus-button:hover {
  background-color: #4f46e5;
}

.dropdown-menu {
  display: none;
  position: absolute;
  bottom: 48px;
  left: 0;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  z-index: 100;
  min-width: 130px;
}

.dropdown-menu button {
  width: 100%;
  padding: 8px 14px;
  background: none;
  border: none;
  text-align: left;
  font-size: 10px;
  color: #111827;
  cursor: pointer;
}

.dropdown-menu button:hover {
  background-color: #f3f4f6;
}

.log-modal {
  position: fixed;
  z-index: 999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
}

.log-modal-content {
  background-color: #fff;
  padding: 24px;
  border-radius: 8px;
  width: 60%;
  max-height: 70%;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.25);
}

.close-modal {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 20px;
  cursor: pointer;
}

.log-modal-body {
  background-color: #f9fafb;
  padding: 16px;
  border-radius: 6px;
  font-family: monospace;
  font-size: 13px;
  margin-top: 12px;
  max-height: 50vh;
  overflow-y: auto;

  white-space: pre-wrap;        /* âœ… ì¤„ë°”ê¿ˆ ìœ ì§€ + wrap */
  word-break: break-word;       /* âœ… ê¸´ ë¬¸ìì—´ ì¤„ë°”ê¿ˆ */
  overflow-wrap: break-word;    /* âœ… ê°•ì œ ì¤„ë°”ê¿ˆ ë³´ì™„ */
}


</style>

<div class="chat-layout">
  <div class="chat-sidebar">
    <h4>ë¦¬í¬íŠ¸ ëª©ë¡</h4>
    <input type="text" placeholder="Search" />
    <ul id="reportListContainer"></ul>
  </div>

  <div class="chat-main">
    <div class="chat-toolbar">
      <select id="llmSelect"></select>
      <button id="newMessageBtn">New Message</button>
    </div>

    <div class="chat-body">
  {% if selected_report %}
    {% for chat in chat_history %}
      <div class="message-bubble from-{{ chat.role }}">{{ chat.text }}</div>
    {% endfor %}
  {% else %}
    <!-- ë¹ˆ ìƒíƒœ ì•ˆë‚´ í™”ë©´ -->
    <div class="empty-state">
      <img src="/static/assets/chat.png" alt="empty" />
      <h3>Messages</h3>
      <p>Click on a report to view messages.</p>
      <button class="start-button">New Message</button>
    </div>
  {% endif %}
</div>


    <div class="chat-footer">
      <!-- + ë²„íŠ¼ê³¼ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
      <div class="dropdown-container">
      <button id="moreBtn" class="plus-button">+</button>
      <div id="dropdownMenu" class="dropdown-menu">
      <button id="viewLogBtn">ì›ë³¸ ë¡œê·¸ ë³´ê¸°</button>
      <button id="downloadBtn">ì±„íŒ… ë‹¤ìš´ë¡œë“œ</button>
      <button id="replaySummaryBtn">ë¶„ì„ ë‹¤ì‹œë³´ê¸°</button>
    </div>
  </div>
      <textarea id="chatInput" placeholder="Your message"></textarea>
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<div id="logModal" class="log-modal" style="display: none;">
  <div class="log-modal-content">
    <span class="close-modal" id="closeLogModal">&times;</span>
    <h3 id="logModalTitle">ë¦¬í¬íŠ¸ ì´ë¦„</h3>
    <div class="log-modal-body" id="logModalBody">ì›ë³¸ ë¡œê·¸ ì¶œë ¥ ì˜ì—­</div>
  </div>
</div>

<!-- âœ… ë¶„ì„ ë‹¤ì‹œ ë³´ê¸°ìš© ëª¨ë‹¬ -->
<div id="summaryModal" class="log-modal" style="display: none;">
  <div class="log-modal-content">
    <span class="close-modal" id="closeSummaryModal">&times;</span>
    <h3 id="summaryModalTitle">ë¶„ì„ ë‹¤ì‹œ ë³´ê¸°</h3>
    <div class="log-modal-body" id="summaryModalBody">ìš”ì•½ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
</div>


<script>
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const chatBody = document.querySelector('.chat-body');
const modelSelect = document.getElementById('llmSelect');
const chatFooter = document.querySelector('.chat-footer');
const reportListContainer = document.getElementById('reportListContainer');
const searchInput = document.querySelector('input[type="text"]');

let isComposing = false;
const urlParams = new URLSearchParams(window.location.search);
let selectedReport = urlParams.get('selected_report');

if (!selectedReport && chatFooter) chatFooter.style.display = 'none';

window.addEventListener('DOMContentLoaded', async () => {
  await loadModelList();

  const promptRaw = urlParams.get('prompt');
  const start = urlParams.get('start') || "";
  const end = urlParams.get('end') || ""; 

  if (!selectedReport && (start && end && promptRaw)) {
    const startStr = start.replace(/-/g, '');
    const endStr = end.replace(/-/g, '');
    selectedReport = `report_${startStr}_${endStr}`;
  }

  if (start && end) {
    localStorage.setItem(`range_${selectedReport}`, JSON.stringify({ start, end }));
  }

  // âœ… New Message ë¦¬í¬íŠ¸ ìƒì„±ìš©: start/end/prompt ì—†ì´ ì§„ì…í•œ ê²½ìš° ì²˜ë¦¬
if ((!start || !end || !promptRaw) && selectedReport) {
  try {
    const res = await fetch("/create-report", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        report_id: selectedReport,
        start: start || "",
        end: end || "",
        text: promptRaw || "(New Message)",
        role: "user"
      })
    });
    const result = await res.json();
    console.log("[ë¦¬í¬íŠ¸ ìƒì„±]", result.status);
  } catch (err) {
    console.error("âŒ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:", err);
  }
}


  // ğŸ”§ ì§„ì… ì‹œ ì„œë²„ì— ë¦¬í¬íŠ¸ ìë™ ìƒì„± ìš”ì²­
  if (start && end && promptRaw && selectedReport) {
    try {
      const res = await fetch("/create-report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          report_id: selectedReport,
          start,
          end,
          text: promptRaw,
          role: "user"
        })
      });
      const result = await res.json();
      console.log("[ë¦¬í¬íŠ¸ ìƒì„±]", result.status);
    } catch (err) {
      console.error("âŒ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:", err);
    }
  }

  const key = `chat_${selectedReport}`;
  const history = JSON.parse(localStorage.getItem(key) || '[]');
  history.forEach(chat => {
    const bubble = document.createElement('div');
    bubble.className = `message-bubble from-${chat.role}`;
    bubble.innerText = chat.text;
    chatBody.appendChild(bubble);
  });

  if (chatInput) chatInput.focus();

  // âœ… ìµœì´ˆ ì§„ì… ì‹œ ìë™ ë¶„ì„
  if (promptRaw && promptRaw !== 'null' && chatInput && history.length === 0) {
    await analyzeLogs(selectedReport, promptRaw, start, end);
  }

  if (chatInput) {
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = chatInput.scrollHeight + 'px';
    });
    chatInput.addEventListener('compositionstart', () => isComposing = true);
    chatInput.addEventListener('compositionend', () => isComposing = false);
    chatInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
        e.preventDefault();
        sendMessage();
      }
    });
  }

  if (sendBtn) {
    sendBtn.addEventListener('click', () => sendMessage());
  }

  async function sendMessage() {
    if (!chatInput || !selectedReport) return;
    const message = chatInput.value.trim();
    if (!message) return;

    const userBubble = document.createElement('div');
    userBubble.className = 'message-bubble from-user';
    userBubble.innerText = message;
    chatBody.appendChild(userBubble);

    chatInput.value = '';
    chatInput.style.height = 'auto';

    const loadingBubble = document.createElement('div');
    loadingBubble.className = 'message-bubble from-assistant';
    loadingBubble.innerText = '...';
    chatBody.appendChild(loadingBubble);
    chatBody.scrollTop = chatBody.scrollHeight;

    try {
      const model = modelSelect.value;
      const summary = localStorage.getItem(`summary_${selectedReport}`) || '';
      const fullPrompt = `
[ìš”ì•½ ì •ë³´]
${summary}

[ì‚¬ìš©ì ì§ˆë¬¸]
${message}`.trim();

      // ğŸ”§ ì‚¬ìš©ì ë©”ì‹œì§€ ì„œë²„ ì €ì¥
      await fetch("/update-report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          report_id: selectedReport,
          start,
          end,
          text: message,
          role: "user"
        })
      });

      const response = await fetch("http://localhost:11434/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ model, prompt: fullPrompt, stream: false })
      });

      const data = await response.json();
      const reply = data.response;

      loadingBubble.remove();
      const botBubble = document.createElement('div');
      botBubble.className = 'message-bubble from-assistant';
      botBubble.innerText = reply;
      chatBody.appendChild(botBubble);
      chatBody.scrollTop = chatBody.scrollHeight;

      const history = JSON.parse(localStorage.getItem(key) || '[]');
      history.push({ role: 'user', text: message });
      history.push({ role: 'assistant', text: reply });
      localStorage.setItem(key, JSON.stringify(history));

      // ğŸ”§ ëª¨ë¸ ì‘ë‹µë„ ì„œë²„ ì €ì¥
      await fetch("/update-report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          report_id: selectedReport,
          start,
          end,
          text: reply,
          role: "assistant"
        })
      });

    } catch (err) {
      loadingBubble.remove();
      const errorBubble = document.createElement('div');
      errorBubble.className = 'message-bubble from-assistant';
      errorBubble.innerText = `âŒ ì‘ë‹µ ì‹¤íŒ¨: ${err.message}`;
      chatBody.appendChild(errorBubble);
    }
  }

  async function analyzeLogs(reportId, prompt, start, end) {
    const model = modelSelect.value;
    const loadingBubble = document.createElement('div');
    loadingBubble.className = 'message-bubble from-assistant';
    loadingBubble.innerText = 'ğŸ” ë³´ì•ˆ ë¦¬í¬íŠ¸ ìë™ ë¶„ì„ ì¤‘...';
    chatBody.appendChild(loadingBubble);
    chatBody.scrollTop = chatBody.scrollHeight;

    const displayPrompt = `ìë™ ë¶„ì„ ìš”ì²­: "${prompt}"`;

    try {
      const userBubble = document.createElement('div');
      userBubble.className = 'message-bubble from-user';
      userBubble.innerText = displayPrompt;
      chatBody.appendChild(userBubble);

      const history = JSON.parse(localStorage.getItem(`chat_${reportId}`) || '[]');
      history.push({ role: 'user', text: displayPrompt });
      localStorage.setItem(`chat_${reportId}`, JSON.stringify(history));

      const response = await fetch("/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ start, end, prompt, model })
      });

      const data = await response.json();
      const result = data?.analysis ?? "âš ï¸ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";

      if (result && result !== "âš ï¸ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.") {
        localStorage.setItem(`summary_${reportId}`, result);
      }

      loadingBubble.remove();
      const botBubble = document.createElement('div');
      botBubble.className = 'message-bubble from-assistant';
      botBubble.innerText = result;
      chatBody.appendChild(botBubble);
      chatBody.scrollTop = chatBody.scrollHeight;

      history.push({ role: 'assistant', text: result });
      localStorage.setItem(`chat_${reportId}`, JSON.stringify(history));
    } catch (err) {
      loadingBubble.remove();
      const errorBubble = document.createElement('div');
      errorBubble.className = 'message-bubble from-assistant';
      errorBubble.innerText = `âŒ ë¶„ì„ ì‹¤íŒ¨: ${err.message}`;
      chatBody.appendChild(errorBubble);

    }
  }
});


  // ğŸ”˜ New Message ë²„íŠ¼ ë™ì‘
document.querySelectorAll('.start-button, .chat-toolbar button').forEach(btn => {
  btn.addEventListener('click', () => {
    const now = new Date();

    const datePart = now.toISOString().slice(0, 10).replace(/-/g, ''); // YYYYMMDD
    const timePart = now.toTimeString().slice(0, 8).replace(/:/g, ''); // HHMMSS

    const newReportId = `report_chat_${datePart}_${timePart}`;
    const existing = JSON.parse(localStorage.getItem('reports') || '[]');

    if (!existing.includes(newReportId)) {
      existing.push(newReportId);
      localStorage.setItem('reports', JSON.stringify(existing));
    }

    localStorage.setItem(`chat_${newReportId}`, JSON.stringify([]));
    window.location.href = `/chat?selected_report=${newReportId}`;
  });
});


  // ë¦¬í¬íŠ¸ ëª©ë¡ ë Œë”ë§
function renderReportList() {
  const reports = JSON.parse(localStorage.getItem('reports') || '[]');
  const selectedReport = new URLSearchParams(window.location.search).get('selected_report');
  const reportListContainer = document.getElementById('reportListContainer');

  reportListContainer.innerHTML = '';

  for (const report of reports) {
    const li = document.createElement('li');
    li.className = (report === selectedReport) ? 'active' : '';

    const wrapper = document.createElement('div');
    wrapper.className = 'report-item-wrapper';

    const a = document.createElement('a');
    a.href = `/chat?selected_report=${report}`;
    a.textContent = report;

    const menuContainer = document.createElement('div');
    menuContainer.className = 'report-menu-container';

    const menuBtn = document.createElement('button');
    menuBtn.className = 'report-menu-btn';
    menuBtn.textContent = 'â‹®';

    const dropdown = document.createElement('div');
    dropdown.className = 'report-dropdown';

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-report-btn';
    deleteBtn.textContent = 'ì‚­ì œí•˜ê¸°';
    deleteBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm(`ğŸ—‘ï¸ ë¦¬í¬íŠ¸ ${report} ì‚­ì œí• ê¹Œìš”?`)) {
        const updated = reports.filter(r => r !== report);
        localStorage.setItem('reports', JSON.stringify(updated));
        localStorage.removeItem(`chat_${report}`);
        renderReportList();
        if (report === selectedReport) {
          window.location.href = '/chat';
        }
      }
    });

    // ë“œë¡­ë‹¤ìš´ í† ê¸€
    menuBtn.addEventListener('click', (e) => {
      e.preventDefault();
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });

    dropdown.appendChild(deleteBtn);
    menuContainer.appendChild(menuBtn);
    menuContainer.appendChild(dropdown);
    wrapper.appendChild(a);
    wrapper.appendChild(menuContainer);
    li.appendChild(wrapper);
    reportListContainer.appendChild(li);
  }
}
renderReportList();


// âœ… "+" ë²„íŠ¼ ê¸°ëŠ¥: ë¡œê·¸ ë³´ê¸° & ë¦¬í¬íŠ¸ ì €ì¥
document.getElementById('moreBtn')?.addEventListener('click', () => {
  const menu = document.getElementById('dropdownMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
});

// ì›ë³¸ ë¡œê·¸ ë³´ê¸°
document.getElementById('viewLogBtn')?.addEventListener('click', async () => {
  const selectedReport = new URLSearchParams(window.location.search).get('selected_report');
  try {
    const res = await fetch(`/get-log?report_id=${selectedReport}`);
    const data = await res.json();

    if (!data.logs || data.logs.trim() === "") {
      alert("ğŸ“­ ì›ë³¸ ë¡œê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    document.getElementById('logModalTitle').innerText = selectedReport;
    document.getElementById('logModalBody').innerText = data.logs;
    document.getElementById('logModal').style.display = 'flex';
  } catch (err) {
    alert("âŒ ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message);
  }
});


// ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('closeLogModal')?.addEventListener('click', () => {
  document.getElementById('logModal').style.display = 'none';
});

// ë¦¬í¬íŠ¸ ì €ì¥ (íƒ€ì„ë¼ì¸/ì¹¨í•´ ê´€ë ¨ ë‚´ìš©ë§Œ ì¶”ì¶œ)
document.getElementById('downloadBtn')?.addEventListener('click', () => {
  const history = JSON.parse(localStorage.getItem(`chat_${selectedReport}`) || '[]');
  if (history.length === 0) return alert('ğŸ“­ ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');

  const filtered = history.filter(h =>
    h.text.includes('íƒ€ì„ë¼ì¸') || h.text.includes('ì¹¨í•´') || h.text.includes('[ìš”ì•½]'));

  const content = filtered.map(h => `- [${h.role}] ${h.text}`).join('\n\n');
  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${selectedReport}_report.txt`;
  a.click();
});

//ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ì‹œ ìë™ ë‹«í˜
document.addEventListener('click', (e) => {
  // ë‹«ê¸°: + ë“œë¡­ë‹¤ìš´ ë©”ë‰´
  const menu = document.getElementById('dropdownMenu');
  const moreBtn = document.getElementById('moreBtn');
  if (menu && !menu.contains(e.target) && e.target !== moreBtn) {
    menu.style.display = 'none';
  }

  // ë‹«ê¸°: ëª¨ë“  ì‚­ì œ ë©”ë‰´
  document.querySelectorAll('.report-dropdown').forEach(dropdown => {
    const parent = dropdown.parentElement.querySelector('.report-menu-btn');
    if (dropdown.style.display === 'block' &&
        !dropdown.contains(e.target) &&
        e.target !== parent) {
      dropdown.style.display = 'none';
    }
  });
});


  // ğŸ” ê²€ìƒ‰ í•„í„°
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const items = reportListContainer.querySelectorAll('li');

      items.forEach(item => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(query) ? '' : 'none';
      });
    });
  }

  async function loadModelList() {
  try {
    const res = await fetch("http://localhost:11434/api/tags");
    const data = await res.json();

    modelSelect.innerHTML = ''; // ê¸°ì¡´ ì˜µì…˜ ì œê±°

    data.models.forEach(model => {
      const option = document.createElement('option');
      option.value = model.name;
      option.textContent = model.name;
      modelSelect.appendChild(option);
    });
  } catch (err) {
    console.error("âŒ ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    modelSelect.innerHTML = `
      <option value="gemma3:4b">gemma3:4b</option>
      <option value="openchat">openchat</option>
    `;
  }
}

// ğŸ“„ ë¶„ì„ ìš”ì•½ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ summaryë§Œ í‘œì‹œ
document.getElementById("replaySummaryBtn").addEventListener("click", async () => {
  const reportId = new URLSearchParams(window.location.search).get('selected_report');

  if (!reportId) {
    alert("ë¦¬í¬íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  try {
    // âœ… JSON íŒŒì¼ ìš”ì²­
    const res = await fetch(`/report/${reportId}`);
    const data = await res.json();

    // âœ… summary í•„ë“œë§Œ ì‚¬ìš©
    const summaryText = data.summary || "ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";

    // âœ… ëª¨ë‹¬ ì œëª©ê³¼ ë‚´ìš© ì±„ìš°ê¸°
    document.getElementById("summaryModalTitle").innerText = `ğŸ“„ ë¶„ì„ ìš”ì•½ (${reportId})`;
    document.getElementById("summaryModalBody").innerText = summaryText;

    // âœ… ëª¨ë‹¬ ì—´ê¸°
    document.getElementById("summaryModal").style.display = "flex";
  } catch (err) {
    console.error("ìš”ì•½ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    alert("ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// âŒ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
document.getElementById("closeSummaryModal").addEventListener("click", () => {
  document.getElementById("summaryModal").style.display = "none";
});



</script>


{% endblock %}
