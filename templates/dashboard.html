{% extends "base.html" %}
{% block title %}ëŒ€ì‹œë³´ë“œ{% endblock %}
{% block header %}Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- ì „ì²´ ìŠ¤íƒ€ì¼ ë° ë ˆì´ì•„ì›ƒ ì •ì˜ -->
<style>
/* ì „ì²´ ë ˆì´ì•„ì›ƒ ì„¤ì • */
html, body {
  height: 100%;
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background-color: #f7f9fc;
  overflow-x: hidden;
}

/* ì‚¬ì´ë“œë°” ê³ ì • */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 80px;
  height: 100vh;
  background-color: #ffffff;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 20px;
  box-sizing: border-box;
  z-index: 100;
}

/* ì‚¬ì´ë“œë°” ì•„ì´ì½˜ ì˜ì—­ */
.menu-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.sidebar-footer {
  margin-top: auto;
  padding-bottom: 20px;
}

.project-name {
  font-size: 13px;
  font-weight: 500;
  color: #111827;
}

/* ì•„ì´ì½˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.icon {
  width: 48px;
  height: 48px;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 12px;
  transition: background-color 0.2s ease;
}

.icon:hover {
  background-color: #e0e7ff;
}

.icon.active {
  background-color: #6366f1;
}

.icon-svg {
  width: 24px;
  height: 24px;
  stroke: #4b5563;
}

.icon.active .icon-svg {
  stroke: white;
}

/* ì˜¤ë¥¸ìª½ ë©”ì¸ ì½˜í…ì¸  */
.main-content {
  margin-left: 80px;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

/* Top Header í™•ì¥ */
.top-header {
  height: 60px;
  background-color: white;
  display: flex;
  align-items: center;
  padding-left: 35px;
  font-weight: bold;
  border-bottom: 1px solid #e5e7eb;
  box-sizing: border-box;
  padding-bottom: 20px;
  padding-top: 20px;
}

/* í˜ì´ì§€ ë°”ë”” ì„¤ì • */
.page-body {
  display: flex;
  flex-direction: column;
  gap: 24px;
  padding: 24px;
  min-height: 100vh;
  background-color: #f7f9fc;
}

/* ë“œë¡­ë‹¤ìš´ ì»¨íŠ¸ë¡¤ */
.dashboard-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* ì°¨íŠ¸ ê·¸ë¦¬ë“œ ì„¤ì • */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}

/* ê° ì°¨íŠ¸ ë°•ìŠ¤ */
.grid-box {
  background-color: white;
  border: 0.5px solid #cbd5e1;
  border-radius: 5px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  min-height: 200px;
}

/* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ë° í¬ê¸° ì œí•œ */
.chart-container {
  height: auto;
  max-height: 240px;
  position: relative;
}

.chart-container canvas {
  width: 100% !important;
  height: auto !important;
  max-height: 180px;
}

/* íˆ´íŒ ìŠ¤íƒ€ì¼ */
.tooltip-container {
  font-weight: bold;
  font-size: 14px;
  margin-bottom: 15px;
  position: relative;
  display: inline-block;
  cursor: help;
}

/* ì§€ë„ ë„“ì´ ë°•ìŠ¤ */
.wide {
  grid-column: span 3;
  padding: 10px;
}


.tooltip-text {
  visibility: hidden;
  width: 240px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 8px;
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;  /* ì¶©ë¶„íˆ ë†’ì€ ê°’ìœ¼ë¡œ ì„¤ì • */
  opacity: 0;
  transition: opacity 0.3s ease;
  font-size: 13px;
  margin-top: 8px;
  font-size: 10px;
}

/* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ íˆ´íŒ ë³´ì´ê¸° */
.tooltip-container:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}
.button-group {
  margin-left: auto;
}

</style>


<!-- ğŸ“‚ ë¡œê·¸ ì„ íƒ ë° ë²„íŠ¼ -->
<!-- ë¡œê·¸ ì„ íƒ + ë²„íŠ¼ -->
<div class="dashboard-controls" style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin: 16px 16px;">
  <!-- ì™¼ìª½: ë¼ë²¨ + ì…€ë ‰íŠ¸ -->
  <div style="display: flex; align-items: center; gap: 8px;">
    <label for="collection-select" style="font-size: 16px;"><strong>ë¡œê·¸ ë‚ ì§œ ì„ íƒ :</strong></label>
    <select id="collection-select" style="padding: 6px 12px; border-radius: 6px; font-size: 10px;">
      <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
    </select>
  </div>

  <!-- ì˜¤ë¥¸ìª½: ë²„íŠ¼ ê·¸ë£¹ -->
  <div class="button-group" style="display: flex; gap: 12px;">
    <button id="download-pdf" style="padding: 8px 16px; border-radius: 6px; background-color: #3b82f6; color: white; border: none; font-weight: bold; font-size: 12px;">
      ğŸ“„ PDFë¡œ ì €ì¥
    </button>
    <button id="send-discord" style="padding: 8px 16px; border-radius: 6px; background-color: #10b981; color: white; border: none; font-weight: bold; font-size: 12px;">
      ğŸ“¤ Discordë¡œ ì „ì†¡
    </button>
  </div>
</div>



<!-- ğŸ“Š ì°¨íŠ¸ ê·¸ë¦¬ë“œ -->
<div class="dashboard-grid">
  <div class="grid-box">
    <div class="tooltip-container">ğŸ•’ ì´ë²¤íŠ¸ ì¶”ì´
      <span class="tooltip-text">ì‹œê°„ íë¦„ì— ë”°ë¼ ë°œìƒí•œ ì´ë²¤íŠ¸ ê°œìˆ˜ë¥¼ ì‹œê³„ì—´ë¡œ í‘œì‹œ. <br>ê°‘ì‘ìŠ¤ëŸ¬ìš´ ê¸‰ì¦ ì—¬ë¶€ ì‹ë³„.</span></div>
    <div class="chart-container"><canvas id="chart1"></canvas></div>
  </div>
  <div class="grid-box">
    <div class="tooltip-container">ğŸš« í—ˆìš© vs ê±°ë¶€
      <span class="tooltip-text">ì „ì²´ íŠ¸ë˜í”½ ì¤‘ í—ˆìš©/ì°¨ë‹¨ ë¹„ìœ¨ ì‹œê°í™”. <br>ì°¨ë‹¨ë¥ ì´ ë†’ìœ¼ë©´ ì´ìƒ ê°€ëŠ¥ì„± ìˆìŒ.</span></div>
    <div class="chart-container"><canvas id="chart2"></canvas></div>
  </div>
  <div class="grid-box">
    <div class="tooltip-container">ğŸŒ ìƒíƒœ ì½”ë“œ
      <span class="tooltip-text">HTTP ìƒíƒœ ì½”ë“œ ë¹„ìœ¨ ë¶„ì„. ì—ëŸ¬ ì½”ë“œ ë¹„ì¤‘ ì¦ê°€ ì—¬ë¶€ ê°ì§€.</span></div>
    <div class="chart-container"><canvas id="chart3"></canvas></div>
  </div>
  <div class="grid-box">
    <div class="tooltip-container">ğŸ“ IPë³„ ì ‘ê·¼
      <span class="tooltip-text">ì ‘ê·¼ëŸ‰ì´ ë§ì€ IP ìˆœì„œëŒ€ë¡œ ë‚˜ì—´. <br>íŠ¹ì • IPì˜ ì§‘ì¤‘ ì ‘ê·¼ ì—¬ë¶€ë¥¼ íƒì§€.</span></div>
    <div class="chart-container"><canvas id="chart4"></canvas></div>
  </div>
  <div class="grid-box">
    <div class="tooltip-container">ğŸ“¦ ë‹¤ìš´ë¡œë“œ Top 5
      <span class="tooltip-text">ëŒ€ìš©ëŸ‰ ë‹¤ìš´ë¡œë“œê°€ ë°œìƒí•œ URI ë˜ëŠ” ì‚¬ìš©ì/IP ìˆœìœ„ë¥¼ ì‹œê°í™”.</span></div>
    <div class="chart-container"><canvas id="chart5"></canvas></div>
  </div>
  <div class="grid-box">
    <div class="tooltip-container">ğŸ” í¬íŠ¸ ìŠ¤ìº” íƒì§€
      <span class="tooltip-text">í¬íŠ¸ ìŠ¤ìº” í”ì ì„ ë‚˜íƒ€ëƒ„. <br>Xì¶•: í¬íŠ¸, Yì¶•: íšŸìˆ˜, ë²„ë¸” í¬ê¸°: IPë³„ ìš”ì²­ëŸ‰ ë“±.</span></div>
    <div class="chart-container"><canvas id="chart6"></canvas></div>
  </div>
  <div class="grid-box wide">
    <div class="tooltip-container" style="padding: 12px;">ğŸŒ êµ­ê°€ë³„ ìš”ì²­ ì§€ë„
      <span class="tooltip-text">GeoIP êµ­ê°€ ê¸°ë°˜ í˜¸ì¶œ ë¶„í¬. <br>ë¹„ì •ìƒ êµ­ê°€ì—ì„œì˜ ìš”ì²­ íƒì§€ ê°€ëŠ¥.</span></div>
    <div id="chart7-map" style="width: 100%; height: 400px; border-radius: 12px;"></div>
  </div>
</div>

<!-- Chart.js ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>


<!-- ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
Chart.defaults.font.size = 10;  // ëª¨ë“  ê¸€ì”¨ í¬ê¸°ë¥¼ ì‘ê²Œ ì„¤ì •
document.addEventListener("DOMContentLoaded", function () {
  // chart1: ì‹œê°„ëŒ€ë³„ ì´ë²¤íŠ¸ ë°œìƒ ì¶”ì´
  fetch("/api/chart1")
    .then(r => r.json())
    .then(data => {
      const dates = data.map(dt => new Date(dt));
      const counts = {};
      dates.forEach(date => {
        const hourStr = date.getFullYear() + "-" +
          String(date.getMonth()+1).padStart(2, "0") + "-" +
          String(date.getDate()).padStart(2, "0") + " " +
          String(date.getHours()).padStart(2, "0") + ":00";
        counts[hourStr] = (counts[hourStr] || 0) + 1;
      });
      const labels = Object.keys(counts).map(str => new Date(str.replace(" ", "T") + ":00"));
      const values = Object.values(counts);
      const sorted = labels.map((dt, i) => ({dt, count: values[i]})).sort((a, b) => a.dt - b.dt);
      new Chart(document.getElementById("chart1"), {
        type: "line",
        data: {
          labels: sorted.map(d => d.dt),
          datasets: [{
            label: "ì´ë²¤íŠ¸ ê±´ìˆ˜",
            data: sorted.map(d => d.count),
            fill: false, tension: 0.2, pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: "time",
              time: { unit: "hour" },
              title: { display: true, text: "ì‹œê°„",font: { size: 9 } }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "ì´ë²¤íŠ¸ ê±´ìˆ˜", font: { size: 9 } }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `ê±´ìˆ˜: ${ctx.parsed.y}`
              }
            }
          }
        }
      });
    });

  // chart2: í—ˆìš©/ê±°ë¶€ ë¹„ìœ¨
  fetch("/api/chart2")
    .then(r => r.json())
    .then(data => {
      const labels = Object.keys(data).map(v => v === "ACCEPT" ? "í—ˆìš©" : "ê±°ë¶€");
      const values = Object.values(data);
      new Chart(document.getElementById("chart2"), {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [{ data: values, borderWidth: 2 }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${ctx.parsed}ê±´`
              }
            }
          }
        }
      });
    });

  // chart3: HTTP ìƒíƒœ ì½”ë“œ ë¹„ìœ¨
  fetch("/api/chart3")
    .then(r => r.json())
    .then(data => {
      const labels = Object.keys(data).map(code => `ìƒíƒœ ${code}`);
      const values = Object.values(data);
      new Chart(document.getElementById("chart3"), {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: ["#4ade80", "#facc15", "#f87171", "#a78bfa", "#60a5fa"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${ctx.parsed}ê±´`
              }
            }
          }
        }
      });
    });

  // chart4: IPë³„ ì ‘ê·¼
  fetch("/api/chart4")
    .then(r => r.json())
    .then(data => {
      const labels = data.map(d => d.ip);
      const values = data.map(d => d.count);
      new Chart(document.getElementById("chart4"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "ì ‘ê·¼ íšŸìˆ˜",
            data: values,
            backgroundColor: "#60a5fa",
            borderRadius: 6,
            barThickness: 20
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          plugins: {
            legend: { display: true, position: "top", align: "start" },
            tooltip: {
              callbacks: {
                label: ctx => `ì ‘ê·¼ íšŸìˆ˜: ${ctx.parsed.x}`
              }
            }
          },
          scales: {
            x: { beginAtZero: true },
            y: { title: { display: false } }
          }
        }
      });
    });
// âœ… chart5: ë‹¤ìš´ë¡œë“œ Top â†’ ë§‰ëŒ€ ì°¨íŠ¸ë¡œ ì¶œë ¥ (5ê°œ ì œí•œ)
fetch("/api/chart5")
  .then(r => r.json())
  .then(data => {
    // 5ê°œ ì´ˆê³¼ì¼ ê²½ìš° ìƒìœ„ 5ê°œë§Œ, ì´í•˜ì¼ ê²½ìš° ì „ì²´ ì¶œë ¥
    const slicedData = data.length > 5 ? data.slice(0, 5) : data;

    const decodedLabels = slicedData.map(item => item.decoded);
    const values = slicedData.map(item => item.count);  // âœ… ìˆ˜ì •: count ê¸°ì¤€ìœ¼ë¡œ ê°’ ì¶”ì¶œ

    const ctx = document.getElementById("chart5").getContext("2d");

    const maxVal = Math.max(...values);
    const suggestedMax = maxVal > 1 ? Math.ceil(maxVal * 1.1) : 1;
    const stepSize = suggestedMax > 5 ? Math.ceil(suggestedMax / 5) : 1;

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: decodedLabels,
        datasets: [{
          label: "ë‹¤ìš´ë¡œë“œ íšŸìˆ˜",
          data: values,
          backgroundColor: "#fb923c",
          borderRadius: 4,
          barThickness: 36
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 20, bottom: 12, left: 12, right: 12 } },
        plugins: {
          legend: { display: true, position: "top" },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.parsed.y}íšŒ ë‹¤ìš´ë¡œë“œ`
            }
          }
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              align: "end",
              font: { size: 8 }
            },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            suggestedMax: suggestedMax,
            ticks: {
              stepSize: stepSize,
              font: { size: 12 }
            },
            grid: { color: "#e5e7eb" }
          }
        }
      }
    });
  })
  .catch(err => {
    console.error("chart5 ì°¨íŠ¸ ë Œë”ë§ ì‹¤íŒ¨:", err);
  });

  // chart6: í¬íŠ¸ ìŠ¤ìº” íƒì§€ (ì„¸ë¡œ ë§‰ëŒ€ + ê°„ê²© í™•ë³´)
fetch("/api/chart6")
  .then(r => r.json())
  .then(data => {
    const labels = data.map(d => d.srcaddr);
    const values = data.map(d => d.num_ports);

    new Chart(document.getElementById("chart6"), {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "í¬íŠ¸ ìˆ˜",
          data: values,
          backgroundColor: "#f87171",
          borderRadius: 6,
          barThickness: 18,        // ë§‰ëŒ€ ë‘ê»˜ ì¡°ì ˆ
          categoryPercentage: 0.6, // ì¹´í…Œê³ ë¦¬ë‹¹ ì‚¬ìš© ë¹„ìœ¨ (ì—¬ë°± í™•ë³´)
          barPercentage: 0.8        // ì‹¤ì œ ë°” í­ ë¹„ìœ¨
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: "top" },
          tooltip: {
            callbacks: {
              label: ctx => `í¬íŠ¸ ìˆ˜: ${ctx.parsed.y}`  // yì¶• ê°’ì„ í‘œì‹œ
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: "IP ì£¼ì†Œ",
              font: { size: 9 }
            },
            ticks: {
              font: { size: 8 },
              color: "#374151"
            },
            grid: {
              display: false
            }
          },
          y: {
            title: {
              display: true,
              text: "í¬íŠ¸ ìˆ˜",
              font: { size: 9 }
            },
            beginAtZero: true,
            ticks: {
              font: { size: 10 },
              color: "#374151",
              stepSize: 1
            },
            grid: {
              color: "#e5e7eb"
            }
          }
        }
      }
    });
  });



// chart7: êµ­ê°€ë³„ ìš”ì²­ ì§€ë„
  const map = L.map('chart7-map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const countryCoords = {
    "KR": [36.5, 127.5],
    "US": [37.8, -96.9],
    "JP": [36.2, 138.2],
    "CN": [35.8, 104.1],
    "RU": [61.5, 105.3],
    "HK": [22.3193, 114.1694]
  };

  fetch("/api/chart7")
    .then(res => res.json())
    .then(data => {
      Object.entries(data).forEach(([countryCode, count]) => {
        const coords = countryCoords[countryCode];
        if (!coords) return;
        L.circleMarker(coords, {
          radius: Math.min(30, 5 + Math.log(count)),
          color: "#f87171",
          fillColor: "#f87171",
          fillOpacity: 0.6
        }).addTo(map).bindPopup(`<b>${countryCode}</b>: ${count}ê±´`);
      });
    });

    const values = Object.values(data);

    const ctx = document.getElementById("chart7-donut").getContext("2d");
    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: [
            "#60a5fa", "#fb923c", "#f87171", "#4ade80", "#a78bfa",
            "#facc15", "#34d399", "#c084fc", "#f97316", "#818cf8"
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.parsed}ê±´`
            }
          }
        }
      }
    });
  });

  // âœ… ë‚ ì§œ ì„ íƒ
fetch("/api/collections/cloudtrail")
  .then(r => r.json())
  .then(data => {
    const select = document.getElementById("collection-select");
    data.collections.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });

    // URLì— ?collection= ê°€ ìˆìœ¼ë©´ ì„ íƒê°’ ë°˜ì˜
    const params = new URLSearchParams(window.location.search);
    const selected = params.get("collection");
    if (selected) {
      select.value = selected;
    }

    // ì„ íƒ ì‹œ URL ë³€ê²½
    select.addEventListener("change", () => {
      const value = select.value;
      const newUrl = value ? `/dashboard?collection=${value}` : "/dashboard";
      window.location.href = newUrl;
    });
  });


  // âœ… PDF ì €ì¥ ë²„íŠ¼ ê¸°ëŠ¥ ì¶”ê°€
  document.getElementById("download-pdf").addEventListener("click", async () => {
  const element = document.querySelector(".dashboard-grid");
  const mapDiv = document.getElementById("chart7-map");

  const canvas = await html2canvas(mapDiv, { useCORS: true });
  const mapImg = document.createElement("img");
  mapImg.src = canvas.toDataURL("image/png");
  mapImg.style.width = "100%";
  mapImg.style.borderRadius = "12px";
  mapImg.style.marginTop = "8px";

  const parent = mapDiv.parentNode;
  mapDiv.style.display = "none";
  parent.appendChild(mapImg);

  const opt = {
    margin: 0.2,
    filename: 'ë³´ì•ˆ_ëŒ€ì‹œë³´ë“œ_ë¦¬í¬íŠ¸.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  await html2pdf().from(element).set(opt).save();
  mapDiv.style.display = "block";
  mapImg.remove();
});

document.getElementById("send-discord").addEventListener("click", async () => {
  const btn = document.getElementById("send-discord");
  btn.disabled = true;
  btn.textContent = "ğŸ“¤ ì „ì†¡ ì¤‘...";

  const element = document.querySelector(".dashboard-grid");
  const mapDiv = document.getElementById("chart7-map");

  const canvas = await html2canvas(mapDiv, { useCORS: true });
  const mapImg = document.createElement("img");
  mapImg.src = canvas.toDataURL("image/png");
  mapImg.style.width = "100%";
  mapImg.style.borderRadius = "12px";
  mapImg.style.marginTop = "8px";

  const parent = mapDiv.parentNode;
  mapDiv.style.display = "none";
  parent.appendChild(mapImg);

  const opt = {
    margin: 0.2,
    filename: 'report.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  const blob = await html2pdf().from(element).set(opt).outputPdf('blob');
  const formData = new FormData();
  formData.append("file", blob, "report.pdf");

  const res = await fetch("/api/send-pdf-discord", {
    method: "POST",
    body: formData
  });

  if (res.ok) {
    btn.textContent = "âœ… ì „ì†¡ ì™„ë£Œ!";
  } else {
    btn.textContent = "âŒ ì „ì†¡ ì‹¤íŒ¨";
  }

  mapDiv.style.display = "block";
  mapImg.remove();
  setTimeout(() => {
    btn.disabled = false;
    btn.textContent = "ğŸ“¤ Discordë¡œ ì „ì†¡";
  }, 3000);
});


</script>
{% endblock %}
